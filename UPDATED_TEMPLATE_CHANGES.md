# Updated n8n Template - Changes Summary

## What Changed

### 1. Variable Names Now Match Webhook Data
All variables in the HTML template now use the **exact names** from the webhook payload.

#### Before (Processed Names):
```html
{{ $json.patientName }}
{{ $json.doctorNote }}
{{ $json.medicinesHtml }}
{{ $json.signatureImage }}
```

#### After (Webhook Names):
```html
{{ $json.customerName }}
{{ $json.doctorNotes }}
{{ $json.medicinesTableRows }}
{{ $json.signaturePdf }}
```

### 2. Fixed Medicine Rows (Always 10 Rows)
The medicines table now has **exactly 10 rows** regardless of how many medicines are prescribed.

#### How It Works:
- **1 medicine prescribed** → Row 1 filled, Rows 2-10 blank
- **5 medicines prescribed** → Rows 1-5 filled, Rows 6-10 blank
- **10 medicines prescribed** → All rows filled

#### Benefits:
- ✅ Consistent spacing between table and next section
- ✅ Professional appearance
- ✅ No layout shifts based on medicine count

### 3. Removed Bundle Breakdown Section
The "Bundle Breakdown" section has been removed from the template.

#### Before:
```html
<div class="section">
    <div class="section-title">Bundle Breakdown</div>
    <div class="section-content">{{ $json.bundleBreakdown }}</div>
</div>

<div class="section">
    <div class="section-title">Doctor Note</div>
    <div class="section-content">{{ $json.doctorNotes }}</div>
</div>
```

#### After:
```html
<div class="section">
    <div class="section-title">Doctor Note</div>
    <div class="section-content">{{ $json.doctorNotes }}</div>
</div>
```

## Updated Code Node Logic

### Medicine Processing
```javascript
// Create exactly 10 medicine rows (fixed number for consistent spacing)
const MAX_MEDICINES = 10;
const medicinesTableRows = Array.from({ length: MAX_MEDICINES }, (_, index) => {
  const medicine = medicines[index] || { name: '', quantity: '', description: '' };
  return `
  <tr>
    <td>${medicine.name}</td>
    <td>${medicine.quantity}</td>
    <td>${medicine.description}</td>
  </tr>`;
}).join('');
```

### Pass-Through Data
```javascript
return [{
  json: {
    // Pass through ALL original webhook data
    ...webhookData,
    
    // Add only 3 processed variables
    medicinesTableRows: medicinesTableRows,
    patientState: patientState,
    formattedSignatureDate: formattedSignatureDate
  }
}];
```

## Complete Variable Reference

### Webhook Variables (Used Directly)
These come directly from the webhook and are used as-is in the template:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{ $json.customerName }}` | Patient name | "John Doe" |
| `{{ $json.customerEmail }}` | Patient email | "john@example.com" |
| `{{ $json.doctorName }}` | Doctor name | "Dr. Smith" |
| `{{ $json.doctorNotes }}` | Doctor's notes | "Take with food..." |
| `{{ $json.signaturePdf }}` | Signature (base64) | "iVBORw0KGgo..." |
| `{{ $json.healthChanges }}` | Health changes | "No" or "Yes - details" |
| `{{ $json.takingMedications }}` | Current medications | "No" or "Yes - list" |
| `{{ $json.hadMedicationBefore }}` | Previous use | "Yes" or "No" |
| `{{ $json.pregnancyStatus }}` | Pregnancy status | "Yes" or "No" |
| `{{ $json.allergicReaction }}` | Allergic reactions | "Yes" or "No" |
| `{{ $json.allergies }}` | Allergies | "No" or "Yes - list" |
| `{{ $json.medicalConditions }}` | Medical conditions | "No" or "Yes - details" |

### Processed Variables (Generated by Code Node)
These are created by the code node:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{ $json.medicinesTableRows }}` | HTML table rows (10 rows) | `<tr><td>Med</td>...</tr>` |
| `{{ $json.patientState }}` | Extracted from shipping | "NSW" |
| `{{ $json.formattedSignatureDate }}` | Formatted date | "18/11/2025" |

## Example Output

### With 3 Medicines:
```
┌─────────────────────────────────────────────────────────┐
│ Non PBS Prescription                                    │
├─────────────────┬──────────┬────────────────────────────┤
│ Name            │ Quantity │ Description                │
├─────────────────┼──────────┼────────────────────────────┤
│ Semaglutide     │ 4 pens   │ Inject 0.25mg weekly       │
│ Needles         │ 8        │ Safety needles 4mm         │
│ Alcohol Swabs   │ 30       │ Pre-injection prep         │
│                 │          │                            │
│                 │          │                            │
│                 │          │                            │
│                 │          │                            │
│                 │          │                            │
│                 │          │                            │
│                 │          │                            │
└─────────────────┴──────────┴────────────────────────────┘

Doctor Note
[Doctor's notes here...]
```

### With 10 Medicines:
```
┌─────────────────────────────────────────────────────────┐
│ Non PBS Prescription                                    │
├─────────────────┬──────────┬────────────────────────────┤
│ Name            │ Quantity │ Description                │
├─────────────────┼──────────┼────────────────────────────┤
│ Medicine 1      │ Qty 1    │ Description 1              │
│ Medicine 2      │ Qty 2    │ Description 2              │
│ Medicine 3      │ Qty 3    │ Description 3              │
│ Medicine 4      │ Qty 4    │ Description 4              │
│ Medicine 5      │ Qty 5    │ Description 5              │
│ Medicine 6      │ Qty 6    │ Description 6              │
│ Medicine 7      │ Qty 7    │ Description 7              │
│ Medicine 8      │ Qty 8    │ Description 8              │
│ Medicine 9      │ Qty 9    │ Description 9              │
│ Medicine 10     │ Qty 10   │ Description 10             │
└─────────────────┴──────────┴────────────────────────────┘

Doctor Note
[Doctor's notes here...]
```

**Notice:** The spacing between the table and "Doctor Note" is **exactly the same** in both cases!

## Files Updated

1. ✅ `n8n-prescription-processor.js` - Updated to generate 10 fixed rows
2. ✅ `n8n-prescription-template.html` - Updated to use webhook variable names
3. ✅ Removed Bundle Breakdown section
4. ✅ All variables now match webhook payload

## Testing

To test the changes:

1. **Test with 1 medicine:**
   - Submit prescription with 1 medicine
   - Verify: 1 row filled, 9 rows blank
   - Check spacing is consistent

2. **Test with 5 medicines:**
   - Submit prescription with 5 medicines
   - Verify: 5 rows filled, 5 rows blank
   - Check spacing is consistent

3. **Test with 10 medicines:**
   - Submit prescription with 10 medicines
   - Verify: All 10 rows filled
   - Check spacing is consistent

4. **Verify variable names:**
   - Check that `customerName` displays correctly
   - Check that `doctorNotes` displays correctly
   - Check that signature displays correctly
   - Check that all health assessments display correctly

## Migration from Previous Version

If you were using the previous version:

1. **Replace Code Node:** Copy new content from `n8n-prescription-processor.js`
2. **Replace HTML Template:** Copy new content from `n8n-prescription-template.html`
3. **Test:** Verify all data displays correctly
4. **Done:** No other changes needed!

The webhook payload from your webapp doesn't need to change - it's already sending the correct data.

